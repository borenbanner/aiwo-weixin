window.Utils=window.Utils||{},$.extend(window.Utils,{validMobile:function(e){return e=""+e,/^((\+86)|(86))?(1)\d{10}$/.test(e)},validPhone:function(e){return e=""+e,/^0[0-9\-]{10,13}$/.test(e)},validNumber:function(e){return/^\d+$/.test(e)},validEmail:function(e){return/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(e)},validPostalCode:function(e){return e=""+e,/^\d{6}$/.test(e)}}),define("wap/components/util/valid",function(){}),define("wap/components/address/model/address",["wap/components/util/valid"],function(){return Backbone.Model.extend({urlRoot:"/v2/buyer/address/item.json",defaults:{tel:"",province:"",postal_code:"",county:"",city:"",area_code:"",address_detail:"",user_name:""},validate:function(e){var t=window.Utils;return e.user_name?e.tel?e.area_code&&"0"!==e.area_code?e.address_detail?""===e.postal_code||t.validPostalCode(e.postal_code)?t.validMobile(e.tel)||t.validPhone(e.tel)?void 0:{msg:"请填写正确的<br />手机号码或电话号码",name:"tel"}:{msg:"邮政编码格式不正确",name:"postal_code"}:{msg:"请填写详细地址",name:"address_detail"}:{msg:"请选择地区",name:""}:{msg:"请填写联系电话",name:"tel"}:{msg:"请填写名字",name:"user_name"}},update:function(e,t){return $.ajax({url:this.url(),type:t||"POST",dataType:"JSON",data:e})}})}),define("wap/components/address/collection/express_address_collection",["wap/components/address/model/address"],function(e){return Backbone.Collection.extend({model:e,url:"/v2/buyer/address/list.json?kdt_id="+window._global.kdt_id,parse:function(e){var t=(e||{}).data||[];return this.total=parseInt(t.length),t}})}),window.Utils=window.Utils||{},$.extend(window.Utils,{makeRandomString:function(e){var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var s=0;e>s;s++)t+=i.charAt(Math.floor(Math.random()*i.length));return t}}),define("wap/components/util/number",function(){}),define("text!wap/components/address/templates/addressForm.html",[],function(){return'\n<form class="js-address-fm address-ui address-fm">\n    <h4 class="address-fm-title">收货地址</h4>\n    <div class="js-address-cancel publish-cancel">\n        <div class="cancel-img"></div>\n    </div>\n    <div class="block" style="margin:0;">\n        <% if(typeof data.id !== \'undefined\') { %>\n            <input type="hidden" name="id" value="<%=data.id %>" />\n        <% } %>\n        <div class="block-item">\n            <label class="form-row form-text-row">\n                <em class="form-text-label">收货人</em>\n                <span class="input-wrapper"><input type="text" name="user_name" class="form-text-input" value="<%=data.user_name %>" placeholder="名字" /></span>\n            </label>\n        </div>\n        <div class="block-item">\n            <label class="form-row form-text-row">\n                <em class="form-text-label">联系电话</em>\n                <span class="input-wrapper"><input type="tel" name="tel" class="form-text-input" value="<%=data.tel %>" placeholder="手机或固话" /></span>\n            </label>\n        </div>\n        <div class="block-item">\n            <div class="form-row form-text-row">\n                <em class="form-text-label">选择地区</em>\n                <div class="input-wrapper input-region js-area-select">\n\n                </div>\n            </div>\n        </div>\n        <div class="block-item">\n            <label class="form-row form-text-row">\n                <em class="form-text-label">详细地址</em>\n                <span class="input-wrapper"><input type="text" name="address_detail" class="form-text-input" value="<%=data.address_detail %>" placeholder="街道门牌信息" /></span>\n            </label>\n        </div>\n        <div class="block-item">\n            <label class="form-row form-text-row">\n                <em class="form-text-label">邮政编码</em>\n                <span class="input-wrapper"><input type="tel" maxlength="6" name="postal_code" class="form-text-input" value="<%=data.postal_code %>" placeholder="邮政编码(选填)" /></span>\n            </label>\n        </div>\n    </div>\n    \n    <div>\n        <div class="action-container">\n            <a class="js-address-save btn btn-block btn-green">保存</a>\n            <% if(typeof data.id !== \'undefined\' && !cannotDelete) { %>\n            <a class="js-address-delete btn btn-block">删除收货地址</a>\n            <% } %>\n        </div>\n    </div>\n</form>\n'}),define("components/regions_data/main",["require","underscore","jquery"],function(e){function t(e,t){h.chain(e).keys().forEach(t)}function i(e){return e.charAt(0).toUpperCase()+e.slice(1)}function s(e,t){var i=new p.Deferred;return p.ajax({url:e,dataType:"jsonp",data:t}).then(function(e){0===e.code?i.resolve(e.data):i.reject(e.msg)}).fail(function(){i.reject("fail")}),i.promise()}function n(e){if(void 0!=e){e+="";var t=e.length;return"00"==e.slice(-2)?n(e.slice(0,t-2)):e}}function o(e,t){if(void 0!=e){e+="";var i=t-e.length;if(i>0)for(;i--;)e+="0";return e}}function a(e,i){t(e,function(t){i[t]=e[t]})}function r(e,t){var i;return t=p.extend({},t),c&&c._beforeStr==e?void 0:(i=h.isString(e)?-1!=e.indexOf("r")?w.cacheAll(t):-1!=e.indexOf("c")?w.cacheProvinceCityList(t):w.cacheProvinceList(t):w.cacheProvinceList(t),c=i,c._beforeStr=e,i)}function d(e,i){var r,d=new p.Deferred;if(i=p.extend({},i),0>e)return[];if(void 0===e)return r=[],t(m.province_list,function(e){r.push({id:e,name:m.province_list[e]})}),d.resolve(r),d.promise();var l,c=n(e),e=o(e,6),h=[];if(l=v[Math.floor(c.length/2)],void 0===l)d.resolve(h);else if(t(m[l],function(e){e.slice(0,c.length)==c&&h.push({id:e,name:m[l][e]})}),0===h.length){var u=f.list;if(void 0!==g[e])return g[e];g[e]=d.promise(),s(u,{region_id:e,display_short_name:i.short||0}).then(function(e){a(e,m[l]),t(e,function(t){h.push({id:t,name:e[t]})}),d.resolve(h)}).always(function(){delete g[e]})}else d.resolve(h);return d.promise()}function l(e,t){return t=p.extend({},t),c?c.then(function(){return d(e,t)}):d(e,t)}var c,h=e("underscore"),p=e("jquery"),u=_global.url.www+"/common/region",f={cityList:"/cityList.jsonp",countyList:"/countyList.jsonp",provinceList:"/provinceList.jsonp",provinceCityList:"/provinceCityList.jsonp",list:"/list.jsonp",all:"/all.jsonp"},m={},w={},v=["province_list","city_list","county_list"],g={};return t(v,function(e){m[v[e]]={}}),t(f,function(e){f[e]=u+f[e],-1!=["provinceList","provinceCityList","all"].indexOf(e)&&(w["cache"+i(e)]=function(t){return t=p.extend({},t),s(f[e],{display_short_name:t.short||0}).then(function(t){return h.extend(m,"provinceList"==e?{province_list:t}:t),p.Deferred().resolve(m)})})}),{preload:r,loadList:l}}),define("wap/components/area/model",["components/regions_data/main"],function(e){var t=function(){},i=Backbone.Model.extend({defaults:{finalCode:0},initialize:function(){return e.preload("pc"),this},getList:function(i){i=i||{};var s=i.callback||t,n=i.code;e.loadList(n).then(_(function(e){s(e)}).bind(this))}});return i}),define("text!wap/components/area/templates/areaSelect.html",[],function(){return'<span>\n	<select id="province" name="province" class="address-province" data-next-type="城市" data-next="city">\n		<option data-code="0" value="省份">省份</option>\n	</select>\n</span>\n<span>\n	<select id="city" name="city" class="address-city" data-next-type="区县" data-next="county">\n		<option data-code="0" value="城市">城市</option>\n	</select>\n</span>\n<span>\n	<select id="county" name="county" class="address-county">\n		<option data-code="0" value="区县">区县</option>\n	</select>\n</span>'}),define("text!wap/components/area/templates/areaOption.html",[],function(){return'<option data-code="0" value="<%= type %>"><%= type %></option>\n<% _.each(data, function(value, key, list){ %>\n	<option data-code="<%= value.id %>" value="<%= value.name %>" <%- value.id == selectedValue ? \'selected\' : \'\' %>>\n		<%= value.name %>\n	</option>\n<%}) %>\n\n'}),define("wap/components/area/main",["wap/components/area/model","text!wap/components/area/templates/areaSelect.html","text!wap/components/area/templates/areaOption.html"],function(e,t,i){var s=function(){},n=Backbone.View.extend({optionTemplate:_.template(i),initialize:function(i){return i=i||{},this.loadingAddress=!1,this.areaSelectTpl=i.areaSelectTpl||t,this.model=new e,this},events:{"change .address-province, .address-city":"changeArea","change .address-county":"changeCounty"},reset:function(e){switch(e){case"province":this.$(".address-city").html(this.optionTemplate({type:"城市",data:[]}));case"city":this.$(".address-county").html(this.optionTemplate({type:"区县",data:[]}))}this.model.set("finalCode",0)},changeCounty:function(){var e=this.$(".address-county option:selected").data("code");this.model.set("finalCode",e)},changeArea:function(e){if(!this.loadingAddress){var t=$(e.target),i=t.find("option:selected").data("code"),s=t.data("next-type"),n=t.attr("id"),o=t.data("next");this.reset(n),0!=i&&this.loadList(o,s,0,i)}},loadList:function(e,t,i,n,o){this.loadingAddress=!0,o=o||s,this.model.getList({code:n,callback:_(function(s){this.loadingAddress=!1,this.$(".address-"+e).html(this.optionTemplate({data:s,type:t,selectedValue:i})),o(s)}).bind(this)})},setArea:function(e){if(e){var t=1e4*parseInt(e/1e4),i=100*parseInt(e/100);this.loadList("province","省份",t,0,_(function(){this.loadList("city","城市",i,t,_(function(){this.loadList("county","区县",e,i),this.model.set("finalCode",e)}).bind(this))}).bind(this))}},getArea:function(){return this.model.get("finalCode")},render:function(e){return e=e||{},this.$el.append(this.areaSelectTpl),this.defaultCode=e.dfcode,this.$("select").on("touchend",function(e){e.preventDefault()}),this.defaultCode?(this.setArea(this.defaultCode),this):(this.loadList("province","省份",0),this)}});return n}),define("wap/components/address/views/logistics_address_edit",["wap/components/address/model/address","wap/components/util/number","text!wap/components/address/templates/addressForm.html","wap/components/area/main"],function(e,t,i,s){return Backbone.View.extend({template:_.template(i),initialize:function(t){{var i=function(){};window.Utils.makeRandomString()}this.ajaxType=t.type,this.model=t.model?t.model:new e,this.doNotSavetoServer=t.doNotSavetoServer,this.cannotDelete=t.cannotDelete,this.onCancelAddAddress=_(function(e){t.onHide(),(t.onCancelAddAddress||i)(e)}).bind(this),this.onFinishEditAddress=_(function(e){t.onHide(),(t.onFinishEditAddress||i)({address_model:e})}).bind(this),this.autoPopup=t.autoPopup===!0,this.listenTo(this.model,"invalid",this.error)},events:{"click .js-address-cancel":"onCancelAddress","click .js-address-save":"onSaveClicked","click .js-address-delete":"onDeleteClicked"},render:function(){return this.$el.html(this.template({data:this.model.toJSON(),cannotDelete:this.cannotDelete})),this.areaBrainView=new s({el:$(".js-area-select")}).render({dfcode:this.model.get("area_code")}),this},onSaveClicked:function(){var e=this,t=$("[name=id]",this.$el),i=this.model.attributes;if(_.each(i,function(t,i){e.model.set(i,$("[name="+i+"]",e.$el).val()||"")}),this.model.set("area_code",this.areaBrainView.getArea()),this.model.set("id",t.length>0?t.val():""),this.model.isValid()){if(this.doNotSavetoServer)return void this.onFinishEditAddress(this.model);this.model.update(i,this.ajaxType).done(function(t){var i=JSON.parse(t);0==i.code?(i.data.id!==!0&&1!==i.data.id&&e.model.set("id",i.data.id),e.onFinishEditAddress(e.model)):motify.log("更新收货地址失败")}).fail(function(){motify.log("更新收货地址失败")})}},onCancelAddress:function(){confirm("确定要放弃此次编辑嘛？")&&this.onCancelAddAddress({autoPopup:this.autoPopup})},onDeleteClicked:function(e){e.stopPropagation();var t=this;if(confirm("确定要删除这个收获地址么？")){var i=$("[name=id]",this.$el).val();this.model.destroy({processData:!0,data:{id:i},wait:!0,success:function(e,i){return i=i||{},t.onFinishEditAddress(),!0},error:function(){motify.log("删除失败。。。")}})}},error:function(e,t){motify.log(t.msg),this.$el.find('input[name="'+t.name+'"]').focus()}})}),define("components/zenjs/backbone/base_view",["components/zenjs/core/trigger_method"],function(e){return Backbone.View.extend({clean:function(){return this.stopListening(),this},triggerMethod:e})}),define("components/zenjs/list/list",["components/zenjs/backbone/base_view"],function(e){var t=function(){};return e.extend({initialize:function(e){return this.options=e=e||{},this.items=[],this.itemView=e.itemView,this.itemOptions=e.itemOptions||{},this.collection=e.collection,this.onAfterListChange=e.onAfterListChange||t,this.onAfterListLoad=e.onAfterListLoad||t,this.onAfterListDisplay=e.onAfterListDisplay||t,this.onListEmpty=e.onListEmpty||e.onEmptyList,this.onItemClick=e.onItemClick||t,this.onViewItemAdded=e.onViewItemAdded||t,this.displaySize=e.displaySize||-1,this.emptyHTML=e.emptyHTML||"",this.emptyText=e.emptyText||"列表为空",this._setupListeners(),this.on("list:empty",_(this._onListEmpty).bind(this)),this},render:function(e){return this.displaySize=-1==(e||{}).displaySize?-1:this.displaySize,this.clean(),this._setupListeners(),this.addAll(),this.onAfterListDisplay({list:this.collection}),this},fetchRender:function(e){return this.collection.fetch({data:e,success:_(function(e,t){this.render(),this.onAfterListLoad(this.collection,t),this.onFetchSuccess&&this.onFetchSuccess()}).bind(this)}),this},_setupListeners:function(){this.collection&&(this.listenTo(this.collection,"add",this.addItem,this),this.listenTo(this.collection,"reset sort",this.render,this),this.listenTo(this.collection,"remove",this.onItemRemoved,this))},addItemListeners:function(e){var t=this;this.listenTo(e,"all",function(){var t="item:"+arguments[0],i=_.toArray(arguments);i.splice(0,1),i.unshift(t,e),this.trigger.apply(this,i),"item:click"==t&&this.onItemClick()}),this.listenTo(e.model,"change",function(){t.onAfterListChange({list:this.collection})})},addAll:function(){0===this.collection.length?this.fetching||this.triggerMethod("list:empty"):this.collection.each(function(e){this.addItem(e)},this)},removeAll:function(){this.collection&&this.collection.each(function(e){this.removeItem(e)},this),this.onAfterListChange({list:this.collection})},addItem:function(e){if(!(this.displaySize>=0&&this.items.length>=this.displaySize)){1==this.collection.length&&(this.listEl||this.$el).html("");var t=new this.itemView(_.extend({},this.options.itemOptions,{model:e,index:this.collection.indexOf(e)}));return this.items.push(t),this.addItemListeners(t),t.render(),this.onViewItemAdded({list:this.items,viewItem:t}),(this.listEl||this.$el).append(t.el),t}},removeItem:function(e){var t=this.getViewByModel(e);t&&this.removeView(t)},removeView:function(e){var t;this.stopListening(e),e&&(this.stopListening(e.model),e.remove(),t=this.items.indexOf(e),this.items.splice(t,1)),0===this.collection.length&&(this.fetching||this.triggerMethod("list:empty"))},onItemRemoved:function(e){this.removeItem(e),this.onAfterListChange()},getViewByModel:function(e){return _.find(this.items,function(t){return t.model===e})},dispatchEventToAllViews:function(e,t){for(var i=this.items.length-1;i>=0;i--)this.items[i].trigger(e,t)},remove:function(){e.prototype.remove.call(this,arguments),this.removeAll()},clean:function(){e.prototype.clean.call(this,arguments),this.removeAll(),(this.listEl||this.$el).html(""),this.stopListening(this.collection)},_onListEmpty:function(){this.$el.html(this.emptyHTML||(this.emptyText?'<p style="text-align:center;line-height:60px;">'+this.emptyText+"</p>":""))}})}),define("text!wap/components/address/templates/addressItem.html",[],function(){return'<div id="js-address-item-<%= data.id %>" class="js-address-item block-item <%= data.selected %>">\n    <div class="icon-check"></div>\n    <p>\n        <% if(typeof(data.name)!== \'undefined\'){ %>\n            <%= data.name %>, <%= data.tel %>\n        <% } else if(typeof(data.user_name)!== \'undefined\'){ %>\n            <%= data.user_name %>, <%= data.tel %>\n        <% } %>\n    </p>\n    <span class="address-str address-str-sf"><%= data.province %><%= data.city %><%= data.county %><%= data.address_detail %></span>\n    <div class="address-opt <% if( data.address_type==\'express\'){ %> js-edit-address <% } %>">\n        <% if( data.address_type==\'express\'){ %>\n            <i class="icon_circle-info">i</i>\n        <% } %>\n    </div>\n</div>\n'}),define("wap/components/pop",["components/zenjs/events","wap/components/util/number"],function(e){var t=function(){};window.zenjs=window.zenjs||{};var i=e.extend({init:function(e){this._window=$(window);var i=window.Utils.makeRandomString();$("body").append('<div id="'+i+'"                 style="display:none; height: 100%;                 position: fixed; top: 0; left: 0; right: 0;                background-color: rgba(0, 0, 0, '+(e.transparent||".9")+');z-index:1000;opacity:0;transition: opacity ease 0.2s;"></div>'),this.nBg=$("#"+i),this.nBg.on("click",_(function(){this.isCanNotHide||this.hide()}).bind(this));var s=window.Utils.makeRandomString();$("body").append('<div id="'+s+'" class="'+(e.className||"")+'" style="overflow:hidden;visibility: hidden;"></div>'),this.nPopContainer=$("#"+s),e.contentViewClass&&(this.contentViewClass=e.contentViewClass,this.contentViewOptions=_.extend({el:this.nPopContainer},e.contentViewOptions||{}),this.contentView=new this.contentViewClass(_.extend({onHide:_(this.hide).bind(this)},this.contentViewOptions))),this.animationTime=e.animationTime||300,this.isCanNotHide=e.isCanNotHide,this.onShow=e.onShow||t,this.onHide=e.onHide||t,this.onFinishHide=e.onFinishHide||t,this.html=e.html},render:function(e){return this.renderOptions=e||{},this.contentViewClass?this.contentView.render(this.renderOptions):this.html&&this.nPopContainer.html(this.html),this},show:function(){return this.top=this._window.scrollTop(),this.nBg.show().css({opacity:"1","transition-property":"none"}),setTimeout(_(function(){this._window.scrollTop(0),this.startShow(),this.nPopContainer.css("visibility","visible"),this._doShow&&this._doShow(),this.onShow()}).bind(this),200),this},hide:function(){var e,t=function(){return e!==this._window.scrollTop()?(this._window.scrollTop(e),void setTimeout(_(t).bind(this))):void setTimeout(_(this.onFinishHide).bind(this),50)};return function(){this._doHide&&this._doHide(),setTimeout(_(function(){this.startHide(),e=this.top,this._window.scrollTop(e),_(t).bind(this)(),this.nBg.css({opacity:0,"transition-property":"opacity"}),setTimeout(_(function(){this.destroy()}).bind(this),200)}).bind(this),this.animationTime),this.onHide()}}(),destroy:function(){return this.nPopContainer.remove(),this.nBg.remove(),this.contentView&&this.contentView.remove(),this},startShow:function(){var e=window.zenjs.popList;e||(e=window.zenjs.popList=[]),e.indexOf(this)<0&&(e.push(this),$("body,html").css({overflow:"hidden",height:this._window.height()}),$("html").css("position","relative"))},startHide:function(){var e=window.zenjs.popList,t=e.indexOf(this);t>-1&&e.splice(t,1),e.length<1&&($("html,body").css({overflow:"visible",height:"auto"}),$("html").css("position","static"))}});return i}),define("wap/components/popup",["wap/components/pop"],function(e){var t=e.extend({init:function(e){this._super(e),this.onClickBg=e.onClickBg||function(){},this.onBeforePopupShow=e.onBeforePopupShow||function(){},this.onAfterPopupHide=e.onAfterPopupHide||function(){},this.nPopContainer.css(e.containerCss||{}),this.nPopContainer.css("opacity","0")},events:{},_doShow:function(){this.contentView&&this.contentView.height?this.height=this.contentView.height():this.contentView||(this.height=this.nPopContainer.height()),this.onBeforePopupShow(),$(".js-popup-close").click(_(function(){this.hide()}).bind(this)),this.nPopContainer.css({height:this.height+"px",transform:"translate3d(0,100%,0)","-webkit-transform":"translate3d(0,100%,0)",opacity:0,position:"absolute","z-index":1e3}),this.bodyPadding=$("body").css("padding"),$("body").css("padding","0px"),setTimeout(_(function(){this.nPopContainer.css({transform:"translate3d(0,0,0)","-webkit-transform":"translate3d(0,0,0)","-webkit-transition":"all ease "+this.animationTime+"ms",transition:"all ease "+this.animationTime+"ms",opacity:1})}).bind(this)),setTimeout(_(function(){this.contentView&&this.contentView.onAfterPopupShow&&this.contentView.onAfterPopupShow()}).bind(this),this.animationTime)},_doHide:function(){this.nPopContainer.css({transform:"translate3d(0,100%,0)","-webkit-transform":"translate3d(0,100%,0)",opacity:0}),setTimeout(_(function(){$("body").css("padding",this.bodyPadding),this.onAfterPopupHide()}).bind(this),this.animationTime)}});return t}),define("wap/components/address/views/logistics_address_list",["wap/components/address/model/address","wap/components/address/views/logistics_address_edit","components/zenjs/list/list","text!wap/components/address/templates/addressItem.html","wap/components/popup"],function(e,t,i,s,n){var o=Backbone.View.extend({initialize:function(e){this.addressType=e.addressType||"self-fetch",this.template=_.template(e.itemTemplateHtml||""),this.onItemClick=e.onItemClick||function(){},this.highLightItem=e.highLightItem||function(){}},events:{click:"onClick","click .js-edit-address":"onEditClicked"},onClick:function(e){var t=$(e.target);t.hasClass("js-edit-address")||t.hasClass("icon_circle-info")||this.onItemClick({address:this.model.toJSON(),addressType:this.addressType})},onEditClicked:function(){var e=function(){this.render(),this.highLightItem()};return function(){new n({contentViewClass:t,contentViewOptions:{onFinishEditAddress:_(e).bind(this),model:this.model,type:"PUT"},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show()}}(),render:function(){return this.$el.html(this.template({data:_.extend(this.model.toJSON(),{address_type:this.addressType})})),this}});return Backbone.View.extend({initialize:function(e){this.template=_.template(e.templateHtml||""),this.addressType=e.addressType,this.autoPopup=e.autoPopup,this.selectedAddress=e.selectedAddress,this._doHide=function(){e.onHide()},this.onAddressChange=e.onAddressChange||function(){},this.onCancel=e.onCancel||function(){},e.collection.comparator=function(e,t){return t.id-e.id},this.listOpt={itemView:o,finishedHTML:" ",collection:e.collection,itemOptions:{addressType:e.addressType,itemTemplateHtml:s,onItemClick:_(this.onItemClick).bind(this),highLightItem:_(this.highLight).bind(this)},onAfterListDisplay:_(this.onAfterListDisplay).bind(this),onAfterListChange:_(this.onAfterListChange).bind(this)}},events:{"click .js-cancel":"onCancelClicked","click .js-add-address":"onAddAddressClicked"},onAfterListChange:function(e){this.onAfterListDisplay(e)},onAfterListDisplay:function(){this.highLight(this.selectedAddress)},onItemClick:function(e){this.hide(),this.onAddressChange(e),this.selectedAddress=e.address},onCancelClicked:function(){this.onCancel(this.addressType),this.hide()},onAddAddressClicked:function(){var i=function(e){e&&(this.collection.add(e.address_model),this.selectedAddress=e.address_model,this.onAddressChange({address:e.address_model.toJSON()}),this.render(),this.show())},s=function(){0===this.listOpt.collection.length?this.hide():this._doShow()};return function(o){new n({contentViewClass:t,contentViewOptions:{onFinishEditAddress:_(i).bind(this),onCancelAddAddress:_(s).bind(this),type:"POST",autoPopup:(o||{}).autoPopup,model:o.selectedAddress?new e(o.selectedAddress):null,cannotDelete:o.cannotDelete},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show()}}(),render:function(){return this.$el.html(this.template({address_type:this.addressType})),this.listOpt.el=this.$(".js-address-container"),this.addressListView=new i(this.listOpt),this.listOpt.collection.length>0?this.addressListView.render():this.addressListView.fetchRender(),this},show:function(e){e=e||{},this._doShow(e.selectedAddress),"express"==this.addressType&&0===this.listOpt.collection.length&&this.onAddAddressClicked(_.extend(e,{cannotDelete:!0}))},highLight:function(e){var t=e||this.selectedAddress||{};this.$(".address-selected").removeClass("address-selected"),this.$("#js-address-item-"+t.id).addClass("address-selected")},_doShow:function(e){this.highLight(e),Backbone.EventCenter.trigger("address_list:show")},hide:function(){this._doHide(),Backbone.EventCenter.trigger("address_list:hide")}})}),window.Utils=window.Utils||{},$.extend(window.Utils,{getRecentlyUsedAddress:function(){var e=null;if(window.localStorage){var t=$.trim(window.localStorage.getItem("recently_used_address"));if(-1!==t.indexOf("undefined")&&(window.localStorage.removeItem("recently_used_address"),t=""),t)try{e=$.parseJSON(t)}catch(i){}}return e},saveLastUsedAddress:function(e){if(!e||!e.user_name)return!1;var t=JSON.stringify(e);if(window.localStorage)try{window.localStorage.setItem("recently_used_address",t)}catch(i){}},wx2KdtAddress:function(e){if(!e)return null;if(!e.userName&&e.user_name)return e;var t={user_name:e.userName,province:e.proviceFirstStageName,city:e.addressCitySecondStageName,county:e.addressCountiesThirdStageName,address_detail:e.addressDetailInfo,tel:e.telNumber,postal_code:e.addressPostalCode,is_weixin:!0};return t},kdt2WxAddress:function(e){if(!e)return null;if(!e.user_name&&e.userName)return e;var t={userName:e.user_name,proviceFirstStageName:e.province,addressCitySecondStageName:e.city,addressCountiesThirdStageName:e.county,addressDetailInfo:e.address_detail,telNumber:e.tel,addressPostalCode:e.postal_code};return t},getPureAddressData:function(e){if(!e||!e.userName)return!1;var t={userName:e.userName,proviceFirstStageName:e.proviceFirstStageName,addressCitySecondStageName:e.addressCitySecondStageName,addressCountiesThirdStageName:e.addressCountiesThirdStageName,addressDetailInfo:e.addressDetailInfo,telNumber:e.telNumber,addressPostalCode:e.addressPostalCode,area_code:e.nationalCode};return t},getPureKdtAddressData:function(e){return e&&e.userName?{user_name:e.userName,province:e.proviceFirstStageName,city:e.addressCitySecondStageName,county:e.addressCountiesThirdStageName,address_detail:e.addressDetailInfo,tel:e.telNumber,postal_code:e.addressPostalCode,area_code:e.nationalCode}:!1},flashAnimate:function(e){e.addClass("animated flashWarn"),window.setTimeout(function(){e.removeClass("flashWarn")},1e3)},getTpl:function(e){var t=$(e);return t?_.template(t.html()):void 0}}),define("wap/components/util/address",function(){}),define("text!wap/components/address/templates/addressPanel.html",[],function(){return'<div class="block block-form block-border-top-none block-border-bottom-none">\n    <div class="js-edit-address js-order-address express-panel express-panel-edit" style="padding-left:0;">\n        <ul class="express-detail">\n            <li class="clearfix"><span class="name">\n                <% if(data.address_type !== \'self-fetch\'){ %>\n                    收货人：\n                <% } else if(data.address_type == \'self-fetch\') { %>\n                    自提点：\n                <% } %>\n                <% if(typeof(data.address.name)!== \'undefined\'){ %>\n                    <%= data.address.name %>\n                <% } else if(typeof(data.address.user_name)!== \'undefined\'){ %>\n                    <%= data.address.user_name %>\n                <% } %>\n            </span><span class="tel"><%= data.address.tel %></span></li>\n            <li class="address-detail">\n                <% if(data.address_type !== \'self-fetch\'){ %>\n                    收货地址：\n                <% } else if(data.address_type == \'self-fetch\') { %>\n                    提货地址：\n                <% } %>\n                <%= data.address.province %><%= data.address.city %><%= data.address.county %><%= data.address.address_detail %>\n            </li>\n        </ul>\n    </div>\n\n    <% if(data.address_type==\'self-fetch\'){ %>\n        <div class="clearfix block-item  <% if( data.order_state > 2) { %> self-fetch-info-show <% } %>">\n            <label>预约人</label>\n            <input  class="txt txt-black ellipsis js-name" placeholder="到店人姓名" value="<%= data.address.user_name %>" <% if( data.order_state > 2) { %> readonly="readonly"<% } %>>\n        </div>\n        <div class="clearfix block-item  <% if( data.order_state > 2) { %> self-fetch-info-show <% } %>">\n            <label>联系方式</label>\n            <input  type=\'text\' class="txt txt-black ellipsis js-phone" placeholder="用于短信接收和便于卖家联系" value="<%= data.address.user_tel %>" <% if( data.order_state > 2) { %> readonly="readonly"<% } %>>\n        </div>\n        <div class="clearfix block-item  <% if( data.order_state > 2) { %> self-fetch-info-show <% } %>">\n            <label class="pull-left">预约时间</label>\n            <input style="width:105px" class="txt txt-black js-time pull-left date-time" type="date" placeholder="日期" value="<%= data.address.user_time.split(\' \')[0] || \'\' %>"  <% if( data.order_state > 2) { %> readonly="readonly"<% } %>/>\n            <input style="width:70px" class="txt txt-black js-time pull-left date-time" type="time" placeholder="时间" value="<%= data.address.user_time.split(\' \')[1] || \'\' %>"  <% if( data.order_state > 2) { %> readonly="readonly"<% } %>/>\n        </div>\n    <% } %>\n</div>\n <% if( data.address_type == \'express\' ){ %>\n    <div class=\'js-logistics-tips logistics-tips font-size-12 c-orange hide\'>很抱歉，该地区暂不支持配送。</div>\n<% } %>\n'}),define("text!wap/components/address/templates/noAddressPanel.html",[],function(){return'<div class="js-order-address express-panel express-panel-no">\n    <div class="js-edit-address empty-address-tip"><span>添加收货地址</span></div>\n</div>\n'}),define("text!wap/components/address/templates/addressList.html",[],function(){return'<div class="js-scene-address-list">\n    <div class="address-ui address-list">\n        <h4 class="address-title">选择收货地址</h4>\n        <div class="cancel-img js-cancel"></div>\n\n        <div class="js-address-container address-container"> </div>\n        <% if(address_type==\'express\'){ %>\n        <div class=\'action-container js-add-address\'>\n            <span class="icon_add"></span>\n            <a class="add-address" href="javascript:;">新增地址</a>\n            <span class="icon_arrow-right"></span>\n        </div>\n        <% } %>\n    </div>\n</div>'}),define("wap/components/address/views/logistics_express",["wap/components/address/model/address","wap/components/address/collection/express_address_collection","wap/components/address/views/logistics_address_edit","wap/components/address/views/logistics_address_list","wap/components/util/address","text!wap/components/address/templates/addressPanel.html","text!wap/components/address/templates/noAddressPanel.html","text!wap/components/address/templates/addressList.html","wap/components/popup"],function(e,t,i,s,n,o,a,r,d){var l=function(){};return Backbone.View.extend({initialize:function(e){e=e||{},e.expressOptions=e.expressOptions||{},a=e.expressOptions.noAddressPanelTpl||a,o=e.expressOptions.addressPanelTpl||o,this.notAutoPopAddress=e.expressOptions.notAutoPopAddress,this.saveAddressToServer=e.expressOptions.saveAddressToServer,this.saveAddressUrl=e.expressOptions.saveAddressUrl,this.expressOptions=e.expressOptions||{},this.notAutoPopAddress=this.expressOptions.notAutoPopAddress,this.address=window._global.expressAddress,this.areaModel=e.areaModel,this.onAddressChanged=e.onAddressChanged||l,this.not_saveToSever=e.not_saveToSever,this.order_state=window._global.order_state,this.template=_.template(o),this.hasAddress()&&0===window._global.expressType?this.doNotSaveToServerNextTime=!0:this.address=Utils.getRecentlyUsedAddress(),this.addressCollection=new t(window._global.address_list||[])
},events:{"click .js-edit-address":"onChangeAddress"},onChangeAddress:function(t){if(!(this.order_state>=3)){if(window._global.no_user_login)return void(this.addressEditView=new d({contentViewClass:i,contentViewOptions:{onFinishEditAddress:_(this.onFinishEditAddress).bind(this),model:this.address?new e(this.address):null,doNotSavetoServer:!0,cannotDelete:!0,areaModel:this.areaModel},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show());this.addressListView=new d({contentViewClass:s,contentViewOptions:{templateHtml:r,addressType:"express",collection:this.addressCollection,onAddressChange:_(this.onAddressChange).bind(this),autoPopup:(t||{}).autoPopup,selectedAddress:this.address,areaModel:this.areaModel},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show(),this.addressListView.contentView.show(_.extend({selectedAddress:this.address},t))}},onFinishEditAddress:function(e){this.address=e.address_model.toJSON(),this.saveAddressToLocal(this.address),this.render()},saveAddressToLocal:function(e){Utils.saveLastUsedAddress(e)},onAddressChange:function(e){this.address=e.address,this.saveAddressToServer&&!this.not_saveToSever?this.doSaveAddressToServer(this.address,"express"):this.$el.html(this.template({data:{address:this.address,address_type:"express"},getEllipsis:this.getEllipsis})),this.saveAddressToLocal(this.address)},hasAddress:function(){return!!this.address&&!!this.address.user_name},getAddress:function(){return this.address},render:function(e){return this.show(e),this},show:function(e){if(e=e||{},e.order_state&&(this.order_state=e.order_state),this.$el.removeClass("hide"),this.hasAddress())this.$el.html(this.template({data:{address:this.address,address_type:"express"},getEllipsis:this.getEllipsis})),e.not_saveToSever||this.not_saveToSever?Backbone.EventCenter.trigger("address:change"):this.saveAddressToServer&&this.doSaveAddressToServer(this.address,"express");else{var t=_.template(a);if(this.$el.html(t()),"self-fetch"===e.from)return;this.notAutoPopAddress||this.onChangeAddress({autoPopup:!0})}this.order_state>=3&&this.$(".js-edit-address").removeClass("express-panel-edit").removeClass("js-edit-address")},getEllipsis:function(e,t){return!e||e.length<=t?e:e.substring(0,t-2)+"..."},showTips:function(){$(".js-logistics-tips").removeClass("hide"),$(".js-express").addClass("no-border-bottom")},hideTips:function(){$(".js-logistics-tips").addClass("hide"),$(".js-express").removeClass("no-border-bottom")},doSaveAddressToServer:function(e,t){var i=this;return i.cannotDeliver=!1,i.hideTips(),Backbone.EventCenter.trigger("address:beforeExpressSend"),this.doNotSaveToServerNextTime?(this.doNotSaveToServerNextTime=!1,Backbone.EventCenter.trigger("address:has"),void this.onAddressChanged({logisticsWay:"express",isResetPriceData:!1})):(i.sendingToServer=!0,void $.ajax({url:i.saveAddressUrl,type:"POST",dataType:"json",timeout:15e3,data:_.extend({is_weixin:!1},e,{order_no:window._global.order_no,kdt_id:window._global.kdt_id}),success:function(s){var n=s.code,o=s.data;0===n?(i.$el.html(i.template({data:{address:e,address_type:t},getEllipsis:i.getEllipsis})),Backbone.EventCenter.trigger("address:change"),i.onAddressChanged({logisticsWay:"express",isResetPriceData:!0,data:o})):10600===n?(i.$el.html(i.template({data:{address:e,address_type:t},getEllipsis:i.getEllipsis})),i.showTips(),i.cannotDeliver=!0):motify.log(s.msg)},error:function(){motify.log("更新收货地址失败")},complete:function(){i.sendingToServer=!1}}))}})}),define("wap/trade/confirm/view/logistics_express_kdt",["wap/components/address/views/logistics_express"],function(e){return e.extend({doSaveAddressToServer:function(e,t){var i=this;return i.cannotDeliver=!1,i.hideTips(),Backbone.EventCenter.trigger("address:beforeExpressSend"),this.doNotSaveToServerNextTime?(this.doNotSaveToServerNextTime=!1,Backbone.EventCenter.trigger("address:has"),void this.onAddressChanged({logisticsWay:"express",isResetPriceData:!1})):(i.sendingToServer=!0,void $.ajax({url:window._global.url.trade+"/trade/order/address.json",type:"POST",dataType:"json",timeout:15e3,data:_.extend({is_weixin:!1},e,{order_no:window._global.order_no,kdt_id:window._global.kdt_id}),success:function(s){var n=s.code,o=s.data;0===n?(i.$el.html(i.template({data:{address:e,address_type:t}})),Backbone.EventCenter.trigger("address:change"),i.onAddressChanged({logisticsWay:"express",isResetPriceData:!0,data:o})):10600===n?(i.$el.html(i.template({data:{address:e,address_type:t}})),i.showTips(),i.cannotDeliver=!0):motify.log(s.msg)},error:function(){motify.log("更新收货地址失败")},complete:function(){i.sendingToServer=!1}}))}})}),define("wap/trade/confirm/view/logistics_express_wx",["wap/trade/confirm/view/logistics_express_kdt","wap/components/util/address"],function(e){return e.extend({onChangeAddress:function(){!wxReady||window._global.order_state>=3||wxReady(_(function(){window.WeixinJSBridge&&window.WeixinJSBridge.invoke("editAddress",window._global.address_token,_(function(e){var t=e.err_msg;if("edit_address:ok"==t){var i=Utils.getPureKdtAddressData(e);i?(this.address=i,this.doSaveAddressToServer(this.address,"express"),this.saveAddressToLocal(this.address)):motify.log("地址数据错误")}else if("access_control:not_allow"===t)return void this.trigger("wx-address:error")}).bind(this))}).bind(this))}})}),define("wap/components/address/config",[],function(){var e=window._global;return{permissions:{wxAddress:e.wxaddress_env,wxPay:e.wxpay_env,aliPay:e.alipay_env}}}),define("wap/components/address/views/logistics_express_wx",["wap/components/address/views/logistics_express","wap/components/util/address"],function(e){return e.extend({onChangeAddress:function(){!wxReady||window._global.order_state>=3||wxReady(_(function(){window.WeixinJSBridge&&window.WeixinJSBridge.invoke("editAddress",window._global.address_token,_(function(e){var t=e.err_msg;if("edit_address:ok"==t){var i=Utils.getPureKdtAddressData(e);i?this.onAddressChange({address:i}):motify.log("地址数据错误")}}).bind(this))}).bind(this))}})}),define("wap/components/address/collection/selffetch_address_collection",["wap/components/address/model/address"],function(e){return Backbone.Collection.extend({model:e,url:"/v2/trade/selffetch/list.json",parse:function(e){var t=(e||{}).data||{};this.total=parseInt(t.total);var i=(t||{}).list||[];return this.total>=0||(this.total=i.length),i}})}),define("wap/components/address/views/logistics_selffetch",["wap/components/address/collection/selffetch_address_collection","wap/components/address/views/logistics_address_list","text!wap/components/address/templates/addressPanel.html","text!wap/components/address/templates/addressList.html","wap/components/popup"],function(e,t,i,s,n){return Backbone.View.extend({template:_.template(i),initialize:function(t){t=t||{},this.address=window._global.selffetchAddress,this.order_state=window._global.order_state,this.not_saveToSever=t.not_saveToSever,this.onAddressChanged=t.onAddressChanged||_f,this.selffetchCollection=new e},events:{"click .js-edit-address":"onEditSelfFetchClicked"},onEditSelfFetchClicked:function(){this.selfFetchAddressListView=new n({contentViewClass:t,contentViewOptions:{templateHtml:s,addressType:"self-fetch",collection:this.selffetchCollection,onAddressChange:_(this.onAddressChange).bind(this),onCancel:_(this.onCancelAddressSelect).bind(this),selectedAddress:this.address},containerCss:{bottom:0,left:0,right:0,background:"white"}}).render().show(),this.selfFetchAddressListView.contentView.show({selectedAddress:this.address})},onAddressChange:function(){var e=function(){var e=new Date;return e.setDate(e.getDate()+1),e.setMinutes(e.getMinutes()-e.getTimezoneOffset()),e.toJSON().slice(0,10)+" "+e.toJSON().slice(11,16)};return function(t){t=t||{};var i=this;return this.address=t.address||{},this.address.user_time=this.address.user_time||e(),this.$el.html(this.template({data:{address:this.address,address_type:"self-fetch",order_state:this.order_state}})),Backbone.EventCenter.trigger("address:beforeExpressSend"),t.not_saveToSever||this.not_saveToSever?void Backbone.EventCenter.trigger("address:change"):void $.ajax({url:"/v2/trade/selffetch/order.json",type:"POST",dataType:"json",timeout:5e3,data:{order_no:window._global.order_no,express_type:t.address.id,address:this.address},beforeSend:function(){},success:function(e){e&&0==e.code?(Backbone.EventCenter.trigger("address:change"),i.onAddressChanged({logisticsWay:"self-fetch",isResetPriceData:!0,data:e.data})):motify.log("地址切换失败，重试一下~"+e.msg)},error:function(){},complete:function(){}})}}(),onCancelAddressSelect:function(){return this.address&&0!==this.address.length?void 0:(this.trigger("no-address:cancel",{addressType:"self-fetch",from:"self-fetch"}),this)},render:function(){return this.show(),this},show:function(e){return e=e||{},e.order_state&&(this.order_state=e.order_state,this.address.user_time=this.address.user_time||e.user_time,this.address.user_tel=this.address.user_tel||e.user_tel,this.address.user_name=this.address.user_name||e.user_name),this.$el.removeClass("hide"),this.address&&0!==this.address.length?(this.onAddressChange({address:this.address,not_saveToSever:e.not_saveToSever}),void(this.order_state>=3&&this.$(".js-edit-address").removeClass("express-panel-edit").removeClass("js-edit-address"))):(this.onEditSelfFetchClicked(),this)}})}),window.zenjs=window.zenjs||{},function(e){e.Event={getTargetByDataKey:function(e,t){for(var i=$(e.target);!i.data(t)&&"BODY"!=(i[0]||{}).nodeName;)i=i.parent();return i},getEventHandler:function(){var t=function(){};return $.extend(!0,t.prototype,e.Event.methods),new t},methods:{events:{},on:function(e,t){return"string"!=typeof e||"[object Function]"!==Object.prototype.toString.call(t)?!1:(this.events[e]||(this.events[e]=[]),this.events[e].push(t))},trigger:function(e){if("string"!=typeof e)return!1;if(!this.events[e])return this.events[e]=[],!1;for(var t=this.events[e],i=Array.prototype.slice.apply(arguments,[1]),s=0,n=t.length;n>s;s++)t[s](i)},off:function(e,t){if(!e&&!t)return void(this.events={});if(!t)return void(this.events[e]=[]);var i=this.events[e],s=i.indexOf(t);i.splice(s,1)}}}}(window.zenjs),define("components/zenjs/util/event",function(){}),define("components/zenjs/backbone/tabber",["components/zenjs/util/event","backbone"],function(e,t){var i=window.zenjs.Event,s=function(){},n=t.View.extend({initialize:function(e){this.activeKey=e.activeKey||"type",this.activeClass=e.activeClass||"active",this.cbOnClicked=e.onClicked||s,this.cbOnDisabledClicked=e.onDisabledClicked||s,this.initDefault(e)},events:{click:"onClicked"},initDefault:function(e){e.defaultData&&e.defaultData.length>0&&this.active(e.defaultData)},onClicked:function(e){if(e.target&&0!==e.target.length){var t=i.getTargetByDataKey(e,this.activeKey),s=""+t.data(this.activeKey);if(t.blur(),this.activeData!==s&&s&&s.length>0){if(this.disabled===!0)return void(this.activeData!==s&&this.cbOnDisabledClicked());this.$("."+this.activeClass).removeClass(this.activeClass),t.addClass(this.activeClass),this.activeData=s,this.cbOnClicked(_.extend(e||{},{value:s,nTarget:t}))}}},active:function(e,t){this.onClicked(_.extend({target:this.$el.find("[data-"+this.activeKey+'="'+e+'"]:first')},t||{}))},setDisable:function(e){this.disabled=e},setData:function(e){this.activeData=e,this.$("."+this.activeClass).removeClass(this.activeClass),this.$el.find("[data-"+this.activeKey+'="'+this.activeData+'"]:first').addClass(this.activeClass)},getData:function(){return this.activeData}});return n}),define("text!wap/components/address/templates/index.html",[],function(){return'<div class="block-item logistics">\n    <!-- <h4 class="block-item-title">配送方式</h4> -->\n    <div class="pull-left js-logistics-select">\n        <button data-type="express" class="tag tag-big" style="margin-top:-3px;">快递配送</button>\n        <button data-type="self-fetch" class="tag tag-big hide js-tabber-self-fetch" style="margin-top:-3px;margin-left: 5px">到店自提</button>\n    </div>\n</div>\n<div class="js-logistics-content logistics-content js-express"></div>\n<div class="js-logistics-content logistics-content js-self-fetch hide"></div>\n'}),define("wap/components/address/main",["wap/components/address/config","wap/components/address/views/logistics_express","wap/components/address/views/logistics_express_wx","wap/components/address/views/logistics_selffetch","components/zenjs/backbone/tabber","text!wap/components/address/templates/index.html"],function(e,t,i,s,n,o){return Backbone.View.extend({initialize:function(s){this.$el.html(o),s=s||{},this.onAddressChanged=s.onAddressChanged||function(){},this.onAddressTypeChange=s.onAddressTypeChange||function(){},this.onWxAddressFailed=s.onWxAddressFailed||function(){},this.not_saveToSever=s.not_saveToSever,this.defaultLogistics=window._global.expressType>0?"self-fetch":"express",this.expressOptions=s.expressOptions;var n=s.logisticsExpressKdtView||t,a=s.logisticsExpressWxView||i,r=window.navigator.userAgent,d=r.match(/MicroMessenger\/(\d+(\.\d+)*)/),l=null!==d&&d.length,c=l?parseFloat(d[1]):0;this.LogisticsExpressView=l?5>c?n:e.permissions.wxAddress?a:n:n,this.logisticsExpressKdtView=n,this.logisticsViews={express:null,"self-fetch":null},this.tabberContainer=this.$(".js-logistics-select"),window._global.allow_self_fetch?this.tabberContainer.find(".js-tabber-self-fetch").removeClass("hide"):this.tabberContainer.parent().addClass("hide")},render:function(){return this.tabber=new n({el:this.tabberContainer,activeClass:"tag-orange",activeKey:"type",defaultData:this.defaultLogistics,onClicked:_(this.onTabberClicked).bind(this),onDisabledClicked:_(this.onDisabledTabberClicked).bind(this)}),this.tabber.setDisable(window._global.order_state>2),this},onTabberClicked:function(e){var t=(this.logisticsViews.express,e.value);if(this.logisticsWay=t,this.onAddressTypeChange({logisticsWay:t}),this.$(".js-logistics-content").addClass("hide"),this.logisticsViews[t])this.logisticsViews[t].show(e),this.$(".js-"+t).removeClass("hide");else{var i="express"==t?this.LogisticsExpressView:s,n=new i({onAddressChanged:this.onAddressChanged,not_saveToSever:this.not_saveToSever,expressOptions:this.expressOptions});this.listenTo(n,"no-address:cancel",this.switch2Other),this.listenTo(n,"wx-address:error",_(this.onWxAddressError).bind(this)),this.logisticsViews[t]=n,this.$(".js-"+t).html(n.render().el).removeClass("hide")}},switch2Other:function(e){var t="express"==e.addressType?"self-fetch":"express";this.tabber.active(t,e)},onDisabledTabberClicked:function(){motify.log("您不能再修改配送方式")},onPayBtnClicked:function(e){this.$(".js-edit-address").hide();var t=window._global.order_state>2?window._global.order_state:3,i=_.extend(e,{order_state:t,not_saveToSever:!0});this.tabber.setDisable(!0),this.logisticsViews[this.logisticsWay].show(i)},getAddress:function(){return this.logisticsViews[this.logisticsWay].getAddress()},onWxAddressError:function(){this.logisticsViews.express&&this.logisticsViews.express.remove();var e=new this.logisticsExpressKdtView({});this.listenTo(e,"no-address:cancel",this.switch2Other),this.logisticsViews.express=e,this.$(".js-express").html(e.render().el).removeClass("hide"),this.logisticsViews.express.onChangeAddress(),this.onWxAddressFailed()}})}),define("wap/components/pop_page",[],function(){var e=Backbone.View.extend({initialize:function(e){this.contentViewClass=e.contentViewClass,this.contentViewOptions=e.contentViewOptions,this.nPageContents=e.nPageContents},render:function(){return this.contentView=new this.contentViewClass(_.extend({onHide:_(this.hide).bind(this),el:this.$el},this.contentViewOptions)).render(),this},show:function(){_.each(this.nPageContents,function(e){e.hide()}),this.$el.show(),window.scrollTo(0,0)},hide:function(){this.$el.hide(),_.each(this.nPageContents,function(e){e.show()})},destroy:function(){this.contentView&&this.contentView.remove()}});return e}),define("wap/components/popout",["wap/components/pop"],function(e){var t=e.extend({init:function(e){e=e||{},this._super(e),this.css=_.extend({position:"absolute","z-index":1e3,transition:"opacity ease "+this.animationTime+"ms",opacity:0,top:"50%",left:"50%","-webkit-transform":"translate3d(-50%, -50%, 0)",transform:"translateY(-50%, -50%, 0)"},e.css||{}),this.nPopContainer.css(this.css)},_doShow:function(){$(".js-popout-close").click(_(function(){this.hide()}).bind(this)),this.nPopContainer.css("opacity",1),this.nPopContainer.show()},_doHide:function(){this.nPopContainer.css({opacity:0})}});return t}),define("wap/components/loading",["wap/components/popout"],function(e){var t;return{show:function(){t=new e({html:'<div class="loader-container"><div class="loader center">处理中</div></div>',isCanNotHide:!0}).render().show()},hide:function(){t.hide()}}}),window.Zepto&&function(e){e.fn.serializeArray=function(){var t,i,s=[],n=function(e){return e.forEach?e.forEach(n):void s.push({name:t,value:e})};return this[0]&&e.each(this[0].elements,function(s,o){i=o.type,t=o.name,t&&"fieldset"!=o.nodeName.toLowerCase()&&!o.disabled&&"submit"!=i&&"reset"!=i&&"button"!=i&&"file"!=i&&("radio"!=i&&"checkbox"!=i||o.checked)&&n(e(o).val())}),s},e.fn.serialize=function(){var e=[];return this.serializeArray().forEach(function(t){e.push(encodeURIComponent(t.name)+"="+encodeURIComponent(t.value))}),e.join("&")},e.fn.submit=function(t){if(0 in arguments)this.bind("submit",t);else if(this.length){var i=e.Event("submit");this.eq(0).trigger(i),i.isDefaultPrevented()||this.get(0).submit()}return this}}(Zepto),define("vendor/zepto/form",function(){}),window.Utils=window.Utils||{},$.extend(window.Utils,{needConfirm:function(e,t,i){var s=window.confirm(e);s?t&&"function"==typeof t&&t.apply():i&&"function"==typeof i&&i.apply()}}),define("wap/components/util/confirm",function(){}),define("wap/components/pay/pay_item",["wap/components/loading","vendor/zepto/form","wap/components/util/confirm"],function(e){var t=window.zenjs.UA,i=Backbone.View.extend({template:_.template('<button type="button" data-pay-type="<%= data.code %>" class="btn-pay btn btn-block btn-large btn-<%= data.code %> <%= getBtnClass(data.code) %>"><%= data.name %></button>'),initialize:function(e){this.onOtherPayClicked=e.onOtherPayClicked||function(){},this.payUrl=e.payUrl,this.kdt_id=e.kdt_id,this.order_no=e.order_no,this.wxPayResultUrl=e.wxPayResultUrl,this.getPayDataExtr=e.getPayDataExtr,this.onPayBtnClicked=e.onPayBtnClicked,this.model.on("change",_(this.render).bind(this)),this.beforeWxPayRender=e.beforeWxPayRender||function(){}},events:{"click button":"onButtonClick"},onButtonClick:function(){var e=this.$("button"),t=e.data("pay-type"),i="";return"other"===t?void this.onOtherPayClicked():"codpay"==t?(i="下单提醒：您正在选择货到付款，下单后由商家发货，快递送货上门并收款。",this.model&&"到店付款"===this.model.get("name")&&(i="下单提醒：您正在选择到店付款，下单后请自行到店领取并付款。"),void((Utils||{}).needConfirm&&Utils.needConfirm(i,_(function(){this.doPay(t)}).bind(this)))):void this.doPay(t)},doPay:function(e){var t=this.getPayDataExtr();if(t){var i={order_no:this.order_no,kdt_id:this.kdt_id,buy_way:e};this.submitPay(_.extend(t,i),e)}},submitPay:function(t,i){var s=this;$.ajax({url:this.payUrl,type:"POST",dataType:"json",timeout:15e3,data:t,cache:!1,beforeSend:function(){e.show(),s.$("button").prop("disabled",!0).html("正在努力加载，请稍等...")},success:function(e){s.onPayBtnClicked(t);var n=e.code;switch(n){case 0:var o=e.data.pay_data,a=e.data.redirect_url,r=e.data.pay_return_url,d=e.data.pay_return_data;if("wxapppay"===i)s.doFinishWxAppPay(o);else if("wxpay"===i)s.doFinishWxPay(o,a,r,d);else if("couponpay"===i||"presentpay"===i)window.location=o.submit_url;else{if(!o||!o.submit_url)return void motify.log("支付过程出错，请联系客服！");s.doFinishOtherPay(o)}break;case 11022:case 11023:wxReady&&wxReady(function(){window.WeixinJSBridge&&window.WeixinJSBridge.invoke("closeWindow",{})});break;case 11010:window.Utils.needConfirm(e.msg,function(){t.accept_price=1,s.submitPay(t,i)},function(){motify.log("正在跳转中...",0),window.location.href=window._global.url.wap+"/showcase/goods?alias="+window._global.goods_alias});break;case 11012:case 11024:case 11026:case 11027:motify.log("正在跳转...");var l="wxpay"!=i?window._global.url.trade+"/trade/order/result?order_no="+s.order_no+"&kdt_id="+s.kdt_id+"#wechat_webview_type=1":s.wxPayResultUrl;window.location.href=l;break;case 21e3:window.location.reload();break;default:s.render(),motify.log(e.msg)}},error:function(){motify.log("生成支付单失败。"),s.render()},complete:function(){e.hide(),s.render()}})},doFinishOtherPay:function(e){if(!this.isSubmitting){this.isSubmitting=!0;var t='<form method="post" action="'+e.submit_url+'">';delete e.submit_url,_(e).map(function(e,i){t+='<input type="hidden" name="'+i+'" value="'+e+'" />'}),t+="</form>";var i=$(t);i.submit(),this.isSubmitting=!1}},doFinishWxPay:function(e,t,i,s){return this.wxpayed?void motify.log("支付数据处理中，请勿重复操作"):(this.wxpayed=!0,"string"==typeof e&&(e=$.parseJSON(e)),void(window.WeixinJSBridge&&(this.beforeWxPayRender(),window.WeixinJSBridge.invoke("getBrandWCPayRequest",e,_(function(e){var n=e.err_msg;this.wxpayed=!1,"get_brand_wcpay_request:ok"===n?(motify.log("支付成功，正在处理订单...",0),$.ajax({url:i,type:"POST",dataType:"json",timeout:15e3,data:s,cache:!1,success:function(){window.location.href=t}})):"get_brand_wcpay_request:fail"===n?(motify.log("支付失败，请重新尝试！"),this.render()):(motify.clear(),this.render())}).bind(this)))))},doFinishWxAppPay:function(){function e(e,i){i||(i="weixin"),t&&(t.isIOS()?(e=encodeURIComponent(e),document.location.hash="#func=appWXPay&params="+e):t.isAndroid()&&window.android.appWXPay(e))}return function(t){e("kdt_id="+t.kdt_id+"&order_no="+t.order_no),window.YouzanJSBridge&&window.YouzanJSBridge.wxPay({kdt_id:t.kdt_id,order_no:t.order_no})}}(),render:function(){var e=this,t=this.model.toJSON();return this.$el.html(this.template(_.extend({data:t},{getBtnClass:function(){return parseInt(e.model.get("order"))>0?" btn-white":" btn-green"}}))),this.$el.css("margin-bottom","10px"),this}});return i}),define("wap/components/pay/pop_pay_list",["wap/components/popout","vendor/zepto/form","wap/components/util/confirm"],function(){var e=Backbone.View.extend({className:"pay-way-opts",initialize:function(e){this.collection=e.collection,$("body").append('<div                 id="confirm-pay-way-opts-popup-bg"                 style="display:none; width: 100%; height: 100%;                 position: fixed; top:0; left:0;                 background-color: rgba(0, 0, 0, .5);"></div>'),this.bg=$("#confirm-pay-way-opts-popup-bg"),this.bg.on("click",_(this.hide).bind(this)),this.listOpt={el:this.$el,itemView:PayItemView,collection:this.collection,itemOptions:e.itemOptions}},events:{"click #confirm-pay-way-opts-popup-bg":"hide"},render:function(){return this.payWayListView=new ListView(this.listOpt).render(),this},show:function(){this.$el.addClass("active"),this.bg.show()},hide:function(){this.$el.removeClass("active"),this.bg.hide()}});return e}),define("wap/components/pay/pay",["components/zenjs/list/list","wap/components/popup","wap/components/pay/pay_item","wap/components/pay/pop_pay_list"],function(e,t,i){return Backbone.View.extend({initialize:function(e){this.collection=new Backbone.Collection,this.nPayTips=e.nPayTips,this.itemOptions=e.itemOptions||{},this.pagePayWaySize=e.pagePayWaySize||3,this.payUrl=e.payUrl||window._global.url.trade+"/trade/order/pay.json",this.order_no=e.order_no||window._global.order_no,this.kdt_id=e.kdt_id||window._global.kdt_id,this.orderPrice=e.orderPrice,this.getPayDataExtr=e.getPayDataExtr||function(){return{}},this.wxPayResultUrl=e.wxPayResultUrl,this.onPayBtnClicked=e.onPayBtnClicked||function(){},this.otherPayText=e.otherPayText,this.beforeWxPayRender=e.beforeWxPayRender||function(){};var t=e.payWays,s=new Backbone.Collection;_.each(t,function(e,t){e.id=t,e.order=t,s.add(new Backbone.Model(e))}),this.listOpt={el:this.$el,itemView:i,collection:this.collection,itemOptions:_.extend(this.itemOptions,{onOtherPayClicked:_(this.onOtherPayClicked).bind(this),payUrl:this.payUrl,order_no:this.order_no,kdt_id:this.kdt_id,getPayDataExtr:this.getPayDataExtr,wxPayResultUrl:this.wxPayResultUrl,onPayBtnClicked:this.onPayBtnClicked,beforeWxPayRender:this.beforeWxPayRender}),emptyHTML:" "},this.allPayWayCollection=s,this.initPagePayWay()},events:{"click .js-other-pay":"onOtherPayClicked"},render:function(){return this.payWayListView=new e(this.listOpt).render(),this},initPagePayWay:function(){if(0===this.allPayWayCollection.length)return this.nPayTips&&this.nPayTips.html("无可用的支付方式"),this;if(this.allPayWayCollection.length<=this.pagePayWaySize)for(var e=0;e<this.allPayWayCollection.length;e++)this.collection.add(this.allPayWayCollection.get(e));else{for(var e=0;e<this.pagePayWaySize-1;e++)this.collection.add(this.allPayWayCollection.get(e));this.collection.add(new Backbone.Model({code:"other",name:this.otherPayText||"其他支付方式",order:e}))}},addHotIcon:function(e){var t=this.allPayWayCollection.findWhere({code:e});if(t){var i=t.get("name")+'<span class="hot"></span>';t.set("name",i);var s=this.collection.findWhere({code:e});if(s)return void s.set("name",i);var n=this.collection.findWhere({code:"other"});n&&n.set("name",n.get("name")+'<span class="hot"></span>')}},initPopPayWayListView:function(){this.popPayWayListView=new t({contentViewClass:e,className:"confirm-pay-way-opts-popup",contentViewOptions:{collection:this.allPayWayCollection,itemView:i,itemOptions:this.itemOptions},containerCss:{bottom:0,padding:"10px",left:0,right:0,background:"white"}}).render().show()},onOtherPayClicked:function(){this.initPopPayWayListView()},updatePayWay:function(e){var t=this.allPayWayCollection.find(function(t){return t.get("code")==e.code});if(t)for(var i in e)e.hasOwnProperty(i)&&t.set(i,e[i])}})}),define("wap/trade/confirm/view/payView",["wap/components/pay/pay"],function(e){var t=function(){};return Backbone.View.extend({initialize:function(i){i=i||{},this.payWays=i.payWays||[],this.payWaysContainer=i.payWaysContainer||$("#confirm-pay-way-opts"),this.getPresentBtn=i.getPresentBtn||$("#get-present-btn"),this.nPayTips=i.nPayTips||$(".js-pay-tip"),this.payUrl=i.payUrl||tradeBaseUrl+"/trade/order/pay.json",this.wxReturnUrl=i.wxReturnUrl||tradeBaseUrl+"/pay/wxpay/return.json",this.wxPayResultUrl=i.wxPayResultUrl||tradeBaseUrl+"/trade/order/result?order_no="+window._global.order_no+"&kdt_id="+window._global.kdt_id+"&order_paid=1#wechat_webview_type=1&refresh",this.order_no=i.order_no||window._global.order_no,this.kdt_id=i.kdt_id||window._global.kdt_id,this.pagePayWaySize=i.pagePayWaySize||2,this.orderType=i.orderType||0,this.onPayBtnClicked=i.onPayBtnClicked||t,this.getPayDataExtr=i.getPayDataExtr||t,this.pagePayWayListView=new e({payWays:this.payWays,el:this.payWaysContainer,nPayTips:this.nPayTips,payUrl:this.payUrl,wxReturnUrl:this.wxReturnUrl,wxPayResultUrl:this.wxPayResultUrl,order_no:this.order_no,kdt_id:this.kdt_id,pagePayWaySize:this.pagePayWaySize,onPayBtnClicked:this.onPayBtnClicked,getPayDataExtr:this.getPayDataExtr});var s=this.solveInnerPayWays(i.innerPayWays||{});this.giftPayWayListView=new e({payWays:s,el:this.getPresentBtn,nPayTips:this.nPayTips,payUrl:this.payUrl,wxReturnUrl:this.wxReturnUrl,wxPayResultUrl:this.wxPayResultUrl,order_no:this.order_no,kdt_id:this.kdt_id,pagePayWaySize:1,onPayBtnClicked:this.onPayBtnClicked,getPayDataExtr:this.getPayDataExtr})},render:function(){this.pagePayWayListView.render(),this.giftPayWayListView.render()},showPresentBtn:function(){this.payWaysContainer.addClass("hide"),this.getPresentBtn.removeClass("hide")},showNormalBuyBtn:function(){this.payWaysContainer.removeClass("hide"),this.getPresentBtn.addClass("hide")},refreshConfirmBtn:function(e){e?this.showNormalBuyBtn():this.showPresentBtn()},updatePayWayList:function(e){this.pagePayWayListView.updatePayWay(e||{})},solveInnerPayWays:function(e){return 4==this.orderType?[e.present]:[e.coupon]}})}),define("wap/trade/message_view",[],function(){return Backbone.View.extend({initialize:function(e){this.onHide=e.onHide||function(){},this.nTarget=e.nTarget},events:{"click .js-cancel":"hide"},render:function(){var e=this.nTarget.parent().parent().clone();this.$(".js-list").empty().append(e),this.$("a.link").hide();var t=$(".js-message");t.length>0?this.$(".js-message-container").html(t.clone().html()):(this.$(".js-message-container").hide(),this.$("h2").hide())},hide:function(){this.onHide()}})}),define("wap/trade/confirm/view/order_message",[],function(){return Backbone.View.extend({initialize:function(e){this.el=e.el,this.msgLenLimit=e.msgLenLimit||140},events:{"focus .js-msg-container":"onMsgFocus","blur .js-msg-container":"onMsgBlur"},render:function(){return this.msgContainer=this.$(".js-msg-container"),this},onMsgFocus:function(){this.msgContainer.addClass("two-rows")},onMsgBlur:function(){this.msgContainer.removeClass("two-rows")},getMsg:function(){return this.msgContainer.val()||""},validate:function(e){return e.length>this.msgLenLimit?(motify.log("字数不能超过"+this.msgLenLimit),!1):!0}})}),define("text!wap/trade/confirm/view/coupon/templates/useCoupon.html",[],function(){return'<div class="block-item order-coupon">\n    <h4 class="block-item-title">优惠</h4>\n    <div class="coupon-info-container">\n	    <div class="js-normal-coupon coupon-info <% if ( orderState < 3 ) { %>js-change-coupon<% } %>">\n	        <span class="coupon-title"><%=couponData.name %></span>\n	        <p><i class="coupon-condition"><%=couponData.condition %></i></p>\n	    </div>\n	    <span class="arrow"></span>\n	</div>\n</div>'}),define("text!wap/trade/confirm/view/coupon/templates/availableCoupon.html",[],function(){return'<div class="block-item order-coupon">\n    <h4 class="block-item-title">优惠</h4>\n    <div class="coupon-info-container">\n	    <div class="js-normal-coupon coupon-info">\n	    	<span class="pull-right <% if ( orderState < 3 ) { %>js-change-coupon<% } %>">您有 <%=available %> 个可用优惠</span>\n	    </div>\n	    <span class="arrow"></span>\n	</div>\n</div>'}),define("text!wap/trade/confirm/view/coupon/templates/emptyCoupon.html",[],function(){return'<div class="block-item order-coupon relative">\n    <h4 class="block-item-title">优惠</h4>\n    <div class="coupon-info-container">\n    	<div class="js-normal-coupon coupon-info">\n    	    <span class="<% if ( orderState < 3 ) { %>js-change-coupon<% } %>">使用优惠</span>\n    	</div>\n    	<span class="arrow"></span>\n    </div>\n\n</div>\n'}),define("wap/trade/confirm/view/coupon/model",[],function(){var e=Backbone.Model.extend({idAttribute:"m_id",defaults:{coupon:null,order:null},initialize:function(){}}),t=Backbone.Collection.extend({model:e});return t}),define("text!wap/trade/confirm/view/coupon/templates/codeInfo.html",[],function(){return"<% if(coupon.value > 0) { %>\n    <em>￥-<%=(coupon.value/100).toFixed(2) %></em>\n<% } %>\n<p><%=coupon.condition %></p>"}),define("wap/trade/confirm/view/coupon/view/code_view",["text!wap/trade/confirm/view/coupon/templates/codeInfo.html","components/zenjs/list/list"],function(e,t){var i=function(){},s=Backbone.View.extend({events:{},initialize:function(e){e=e||{},this.useCoupon=e.useCoupon||i,this.listOpt={el:this.$(".js-coupon-container .js-coupon-code-list"),itemView:e.CouponItemView,finishedHTML:" ",collection:e.collection,itemOptions:{itemTemplateHtml:$("#tpl-address-item").html(),onItemClick:this.useCoupon},onEmptyList:function(){}},this.urlTrade=e.urlTrade},render:function(){var e=window._global;return this.CodeListView=new t(this.listOpt),this.CodeListView.render(),this.codeInputerEle=this.$(".js-code-inputer"),this.codeInputer=new n({el:this.codeInputerEle,useCoupon:this.useCoupon,order_no:e.order_no,kdt_id:e.kdt_id,urlTrade:this.urlTrade}),this}}),n=Backbone.View.extend({events:{"input .js-code-txt":"checkCode","click .js-valid-code":"validCode"},codeInfoTemplate:_.template(e),initialize:function(e){e=e||{},this.useCoupon=e.useCoupon,this.urlTrade=e.urlTrade,this.order_no=e.order_no,this.kdt_id=e.kdt_id,this.nCodeTxt=this.$(".js-code-txt"),this.nValidBtn=this.$(".js-valid-code")},checkCode:function(e){e.preventDefault();var t=this.getCode();
this.nValidBtn.prop("disabled",0===t.length)},getCode:function(){var e=this,t=e.nCodeTxt.val();return t=$.trim(t)},validCode:function(e){var t=this;e.preventDefault();var i=t.getCode();return i?void t.validToServer(i):(motify.log("请输入优惠码"),t.nCodeTxt.focus(),!1)},validToServer:function(e){var t=this,i=this.urlTrade+"/trade/order/validateCode.json";$.ajax({url:i,type:"POST",dataType:"json",timeout:8e3,cache:!1,data:{order_no:t.order_no,kdt_id:t.kdt_id,code:e},beforeSend:function(){t.nValidBtn.text("验证中..."),t.nValidBtn.prop("disabled",!0)},success:function(e){0===e.code?t.showCouponInfo(e.data):motify.log(e.msg)},error:function(){},complete:function(){t.nValidBtn.text("验证"),t.nValidBtn.prop("disabled",!1)}})},showCouponInfo:function(e){var t=this,i=Utils.checkIsExist(e);if(i)motify.log("该优惠码您已经拥有，<br />已为您自动选中～");else{var s=t.codeInfoTemplate(e);this.$(".js-coupon-info").html(s),Utils.setCouponIdAttr(t.$el,e)}this.useCoupon(e)}});return s}),define("text!wap/trade/confirm/view/coupon/templates/couponItem.html",[],function(){return'<label class="label-check">\n    <div class="label-check-img"></div>\n    <div class="coupon-info">\n        <span><%=coupon.name %></span>\n        <em>￥-<%=(coupon.value/100).toFixed(2) %></em>\n        <p><%=coupon.condition %></p>\n    </div>\n</label>\n'}),define("wap/trade/confirm/view/coupon/view/item_view",["text!wap/trade/confirm/view/coupon/templates/couponItem.html"],function(e){var t=function(){},i=Backbone.View.extend({tagName:"div",className:"block-item order-coupon order-coupon-item",template:_.template(e),events:{click:"onClick"},initialize:function(e){e=e||{},this.onItemClick=e.onItemClick||t},render:function(){var e=this.model.toJSON(),t=this.template(e);return this.$el.html(t),Utils.setCouponIdAttr(this.$el,e),this},onClick:function(e){e.preventDefault();var t=this.model.toJSON();this.onItemClick(t)}});return i}),define("wap/trade/confirm/view/coupon/view/card_view",["wap/trade/confirm/view/coupon/view/item_view","components/zenjs/list/list"],function(e,t){var i=function(){},s=Backbone.View.extend({initialize:function(t){t=t||{},this.collection=t.collection||[],this.listOpt={el:this.$(".js-coupon-container"),itemView:e,finishedHTML:" ",collection:t.collection,itemOptions:{itemTemplateHtml:$("#tpl-address-item").html(),onItemClick:t.useCoupon||i}}},render:function(){return this.CodeListView=new t(this.listOpt),this.CodeListView.render(),this.collection.length>0&&this.$el.show(),this}});return s}),define("wap/trade/confirm/view/coupon/view/confirm_view",[],function(){var e=function(){},t=Backbone.View.extend({events:{"click .js-confirm-coupon":"confirmUse"},initialize:function(t){t=t||{},this.onCouponChanged=t.onCouponChanged||e,this.nTotalCoupon=this.$(".js-total-privilege")},confirmUse:function(e){e.preventDefault(),this.$el.hide(),this.onCouponChanged(this.selectedCoupon)},useCoupon:function(e){if(this.selectedCoupon=e,!e)return!1;var t=e.coupon,i=t.value||0,s="总优惠：¥"+(i/100).toFixed(2);this.nTotalCoupon.html(s)},show:function(){this.$el.show()}});return t}),define("wap/trade/confirm/view/coupon/view/selector_view",["wap/trade/confirm/view/coupon/model","wap/trade/confirm/view/coupon/view/code_view","wap/trade/confirm/view/coupon/view/card_view","wap/trade/confirm/view/coupon/view/confirm_view","wap/trade/confirm/view/coupon/view/item_view","components/zenjs/list/list"],function(e,t,i,s,n,o){var a=function(){},r=Backbone.View.extend({events:{"click .js-not-use":"notUse"},initialize:function(e){e=e||{},this.onCouponChanged=e.onCouponChanged||a,this.orderState=e.orderState,this.selectedCoupon=null,this.coupons=this.originalCoupon=e.coupons||{},this.currentCoupon=e.currentCoupon||{},this.urlTrade=e.urlTrade},render:function(){window._global;return this.codeCollection=new e(this.coupons.codes||[]),this.codesView=new t({el:this.$(".js-code-container"),collection:this.codeCollection,useCoupon:_(this.useCoupon).bind(this),CouponItemView:n,urlTrade:this.urlTrade}).render(),this.cardCollection=new e(this.coupons.cards||[]),this.listOpt={el:$(".js-card-container .js-coupon-container"),itemView:n,finishedHTML:" ",collection:this.cardCollection,itemOptions:{itemTemplateHtml:$("#tpl-address-item").html(),onItemClick:_(this.useCoupon).bind(this)||a},onEmptyList:function(){}},this.cardsView=new o(this.listOpt),this.cardsView.render(),this.cardCollection.length>0&&$(".js-card-container").show(),this.confirmUseView=new s({el:$(".js-confirm-use-coupon"),onCouponChanged:this.onCouponChanged}),this.confirmShow=_(this.confirmUseView.show).bind(this.confirmUseView)||a,this},setCoupons:function(e){this.codeCollection.reset(e.codes||this.originalCoupon.codes),this.cardCollection.reset(e.cards||this.originalCoupon.cards),this.coupons=e||this.originalCoupon},notUse:function(e){var t=this;e.preventDefault();var i=t.coupons.none_coupon;this.useCoupon(i)},useCoupon:function(e){this.selectedCoupon=e,this.confirmUseView&&this.confirmUseView.useCoupon(e),this.show()},show:function(){var e=this,t=e.selectedCoupon;if(!t)return!1;e.$el.find(".order-coupon-item").removeClass("active");var i=Utils.findCouponItem(t);i.addClass("active")},autoUseCoupon:function(){var e=this,t=e.coupons,i=e.orderState,s=null;if(1===i||2===i){if(!t)return!1;s=t.default_coupon?t.default_coupon:t.none_coupon}else 3===i&&(s=this.currentCoupon);this.useCoupon(s),this.onCouponChanged(s)}});return r}),window.Utils=window.Utils||{},$.extend(window.Utils,{setCouponIdAttr:function(e,t){var i=t.coupon,s="coupon-"+i.type+"-"+i.id;e.attr("id",s)},findCouponItem:function(e){var t=e.coupon,i="#coupon-"+t.type+"-"+t.id,s=$(i);return s},checkIsExist:function(e){var t=this.findCouponItem(e),i=t.length>0;return i}}),define("wap/components/util/coupon",function(){}),define("wap/trade/confirm/view/coupon/main",["text!wap/trade/confirm/view/coupon/templates/useCoupon.html","text!wap/trade/confirm/view/coupon/templates/availableCoupon.html","text!wap/trade/confirm/view/coupon/templates/emptyCoupon.html","wap/trade/confirm/view/coupon/view/selector_view","wap/components/util/coupon"],function(e,t,i,s){var n=function(){},o=Backbone.View.extend({el:".js-used-coupon",events:{"click .js-change-coupon":"showCouponSelector"},useCouponTemplate:_.template(e),availableCouponTemplate:_.template(t),emptyCouponTemplate:_.template(i),initialize:function(e){var t=window._global,i=t.ump||{},s=((i.order||{}).coupons||{}).money||{};e=e||{},this.orderState=t.order_state||1,this.hasAddress=0,this.coupons=t.coupons||{},this.currentCoupon=s||{},this.urlTrade=t.url.trade,this.no_user_login=t.no_user_login,this.onCouponChanged=e.onCouponChanged||n,this.contentEle=$(".js-page-content").find(".content"),this.footerEle=$(".footer"),this.modalEle=$(".js-modal"),this.orderTotalEle=$(".js-order-total")},render:function(e){if(e=e||{},!this.coupons&&this.orderState<3)return this;this.no_user_login;var t=window._global;return this.couponSelectorView=new s({el:$(".js-coupon-ui"),orderState:this.orderState,coupons:this.coupons,currentCoupon:this.currentCoupon,order_no:t.order_no,kdt_id:t.kdt_id,urlTrade:this.urlTrade,onCouponChanged:_(function(e){this.onCouponChanged(e),this.hideCouponSelector(),this.updateCouponPanel(e)}).bind(this)}).render(),this.couponSelectorView.autoUseCoupon(),this},setCoupons:function(e){this.couponSelectorView&&(this.coupons=e||{},this.couponSelectorView.setCoupons(e||{}),this.couponSelectorView.autoUseCoupon())},resetCoupons:function(){this.setCoupons()},showCouponSelector:function(){this.couponSelectorView.show(),motify.clear(),$(".scene").filter(".js-scene-coupon-list").removeClass("hide").siblings(".scene").addClass("hide"),this.contentEle.hide(),this.footerEle.hide(),this.modalEle.addClass("active"),this.couponSelectorView.confirmShow()},hideCouponSelector:function(){this.modalEle.removeClass("active"),this.contentEle.show(),this.footerEle.show()},updateCouponPanel:function(e){var t=this,i="";if(t.usedCoupon=e,!e)return!1;var s=e.coupon||{};if(0!==s.id)i=t.useCouponTemplate({couponData:s,orderState:t.orderState});else{var n=t.coupons?t.coupons.total:0;i=n>0?t.availableCouponTemplate({available:n,orderState:t.orderState}):t.emptyCouponTemplate({orderState:t.orderState})}t.$el.html(i),t.$el.show(),(1===t.orderState||2===t.orderState)&&Utils.flashAnimate(t.$(".block > .block-item"))}});return o}),define("text!wap/trade/confirm/templates/totlePrice.html",[],function(){return"<p>￥<%= (data.goods_price/100).toFixed(2) %> + ￥<%= (data.postage/100).toFixed(2) %>运费\n    <% if (data.decrease!=undefined && data.decrease!=0) { %>\n        - ￥<%= (data.decrease/100).toFixed(2) %>优惠\n    <% } %>\n    <% if (data.reduce_money!=undefined && data.reduce_money!=0) { %>\n        - ￥<%= (data.reduce_money/100).toFixed(2) %>满减优惠\n    <% } %>\n    <% if (data.operation_price!=undefined && data.operation_price!=0) { %>\n        <%= (data.operation_price > 0) ? '+' : '-' %> ￥<%= new Number(Math.abs(data.operation_price)/100).toFixed(2) %>改价\n    <% } %>\n</p>\n<strong class=\"js-real-pay c-orange js-real-pay-temp\">\n    需付：￥<%= getFinalPrice() %>\n</strong>"}),define("wap/trade/confirm/view/priceBrain",["text!wap/trade/confirm/templates/totlePrice.html"],function(e){var t=_.template(e);return Backbone.View.extend({initialize:function(e){this.nTotalPrice=$(".js-order-total");var t=e.ump||{},i=(((t.order||{}).coupons||{}).money||{}).order,s=(t.order||{}).operation;this.priceData={goods_price:i.goods_price,real_pay:i.real_pay,postage:i.postage,reduce_money:((t.order||{}).reduce||{}).cash||0,operation_price:0,decrease:0},s&&(this.priceData.operation_price=s.new_pay-s.origin_pay||0)},render:function(){this.changePrice()},changePrice:function(){var e=((((window._global.ump||{}).order||{}).coupons||{}).money||{}).order;if(e){var i=this.getShowData();this.nTotalPrice.html(t({data:i,getFinalPrice:_(function(){return(this.getFinalPrice(i)/100).toFixed(2)}).bind(this)}))}},getShowData:function(){var e=this.priceData,t=this.couponData,i=e.postage;return this.isSelfFetch&&(i=0),t&&(e.decrease=t.order.decrease),_.extend(e,{postage:i})},getFinalPrice:function(e){var e=e||this.getShowData();return+e.goods_price+ +e.postage-e.reduce_money-e.decrease+e.operation_price},setPostage:function(e){this.priceData.postage=e}})}),define("wap/components/wx_image_preview",["require"],function(){function e(e){var t=e.attr("data-src")||e.attr("src"),i=t.replace(/!.*?\.jpg/i,"!640x320.jpg");return i}var t=[],i=function(e,t){window.WeixinJSBridge&&window.WeixinJSBridge.invoke("imagePreview",{current:e,urls:t})};return{init:function(){var s=$(".js-view-image"),n=0;s.each(function(){var s=$(this),o=e(s);s.width()>=n&&o&&(t.push(o),s.on("click",function(){i(o,t)}))}),$(".js-view-image-list").each(function(){var t=$(this);t.on("click",".js-view-image-item",function(){var s=t.find(".js-view-image-item");s=s.map(function(){var t=$(this);return e(t)}).toArray();var n=e($(this));i(n,s)}),t.on("click",".js-view-single-image",function(){var t=e($(this));i(t,[t])})})},clear:function(){t=[]}}}),require(["wap/trade/confirm/view/logistics_express_kdt","wap/trade/confirm/view/logistics_express_wx","wap/components/address/main","wap/components/util/address","wap/components/pop_page","wap/trade/confirm/view/payView","wap/trade/message_view","wap/trade/confirm/view/order_message","wap/trade/confirm/view/coupon/main","wap/trade/confirm/view/priceBrain","text!wap/trade/confirm/templates/totlePrice.html","wap/components/wx_image_preview"],function(e,t,i,s,n,o,a,r,d,l,c,h){Backbone.EventCenter=_.extend({},Backbone.Events);{var p=Backbone.View.extend({initialize:function(){Backbone.EventCenter.on("address_list:show",this.hideContainer),Backbone.EventCenter.on("address_list:hide",this.showContainer),Backbone.EventCenter.on("address:has",this.showPaymentArea),Backbone.EventCenter.on("address:change",this.showPaymentArea),Backbone.EventCenter.on("address:beforeExpressSend",this.hidePaymentArea);var s=window._global;this.couponView=new d({onCouponChanged:_(function(e){this.priceBrainView.couponData=e,this.priceBrainView.changePrice(),this.payContainerView.refreshConfirmBtn(this.priceBrainView.getFinalPrice())}).bind(this)});var n=$("#js-logistics-container");n.length>0&&(this.expressWaysView=new i({el:n,onAddressChanged:_(this.onAddressChanged).bind(this),logisticsExpressKdtView:e,logisticsExpressWxView:t,onWxAddressFailed:_(this.hideWxPay).bind(this),not_saveToSever:s.order_state>2,expressOptions:{saveAddressToServer:!0,saveAddressUrl:s.url.trade+"/trade/order/address.json"}})),this.orderMessageView=new r({el:$("#js-order-message")}).render();var a=s.url.trade;this.payContainerView=new o({payWays:s.payWays,innerPayWays:s.innerPayWays,payWaysContainer:$("#confirm-pay-way-opts"),getPresentBtn:$("#get-present-btn"),nPayTips:$(".js-pay-tip"),payUrl:a+"/trade/order/pay.json",wxReturnUrl:a+"/pay/wxpay/return.json",wxPayResultUrl:a+"/trade/order/result?order_no="+s.order_no+"&kdt_id="+s.kdt_id+"&order_paid=1#wechat_webview_type=1&refresh",order_no:s.order_no,kdt_id:s.kdt_id,pagePayWaySize:parseInt(s.pagePayWaySize||2),onPayBtnClicked:_(this.onPayBtnClicked).bind(this),getPayDataExtr:_(this.getPayDataExtr).bind(this),orderType:s.order_type}),this.priceBrainView=new l({ump:s.ump||{}}),$.fn.MiniCounter&&$(".js-mini-counter").MiniCounter({callback:function(){$(".js-counter-msg").html('<h3>订单状态：您的订单已取消。</h3><hr /><p class="c-orange">您的订单因超时未付款，已经自动取消。</p>')}}),h.init(),s.order_state>2&&this.showPaymentArea()},render:function(){return this.expressWaysView&&this.expressWaysView.render(),this.priceBrainView.render(),this.couponView.render(),this.payContainerView.render(),this.payContainerView.refreshConfirmBtn(this.priceBrainView.getFinalPrice()),this},events:{"click .js-show-message":"onShowMessageClicked"},getPayDataExtr:function(){var e={},t=this.priceBrainView.couponData;if(t){var t=t.coupon;t&&(e.coupon_id=t.id,e.coupon_type=t.type)}var i=this.orderMessageView.getMsg();if(!this.orderMessageView.validate(i))return!1;if(e.order_message=i,!this.expressWaysView)return e;{var s=this.expressWaysView.logisticsWay,n=this.expressWaysView.logisticsViews[s];n.address}if("express"===s)return n.cannotDeliver?(motify.log("该地区暂不支持配送<br/>请修改收货地址"),!1):n.sendingToServer?(motify.log("收货地址提交中，请稍等"),!1):(e.express_type=s,e);var o=$(".js-self-fetch .js-name").val().trim(),a=$(".js-self-fetch .js-phone").val().trim(),r=$(".js-self-fetch .js-time[type=date]").val().trim(),d=$(".js-self-fetch .js-time[type=time]").val().trim();return o?Utils.validPhone(a)||Utils.validMobile(a)?r&&d?_.extend(e,{user_name:o,user_tel:a,user_time:r+" "+d,express_type:s}):(motify.log("请填写预约时间"),!1):(motify.log("请填写正确的联系方式"),!1):(motify.log("请填写您的姓名！"),!1)},hideWxPay:function(){},onShowMessageClicked:function(e){this.messagePopPage=new n({nPageContents:[$("#js-page-content")],el:$("#sku-message-poppage"),contentViewClass:a,contentViewOptions:{nTarget:$(e.target)}}).render().show()},onPayBtnClicked:function(e){this.expressWaysView&&this.expressWaysView.onPayBtnClicked(e)},hideContainer:function(){},showContainer:function(){},showPaymentArea:function(){$(".js-step-topay").removeClass("hide")},hidePaymentArea:function(){$(".js-step-topay").addClass("hide")},onAddressChanged:function(e){if(this.isSelfFetch="self-fetch"===e.logisticsWay,this.priceBrainView.isSelfFetch=this.isSelfFetch,this.payContainerView.updatePayWayList({code:"codpay",name:this.isSelfFetch?"到店付款":"货到付款"}),e.isResetPriceData){var t=(e.data||{}).pay_data||{};this.priceBrainView.setPostage(t.postage),this.couponView.setCoupons((e.data||{}).coupons)}this.priceBrainView.changePrice(),this.payContainerView.refreshConfirmBtn(this.priceBrainView.getFinalPrice())}});new p({el:$("body")}).render()}}),define("main",function(){});